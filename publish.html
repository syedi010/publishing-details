<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Publishing Details Form</title>
<style>
    body { font-family: Arial, sans-serif; background-color: #f4f6f8; padding: 20px; }
    h1 { text-align: center; color: #333; }
    .form-container { max-width: 1200px; margin: 0 auto; }
    .card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 20px; background-color: #fff; box-shadow: 0 3px 10px rgba(0,0,0,0.05); }
    .card h3 { margin-top: 0; margin-bottom: 15px; color: #007BFF; }
    .field-group { display: flex; flex-wrap: wrap; margin-bottom: 12px; }
    .field-group label { flex: 1 0 200px; margin-right: 10px; font-weight: bold; }
    .field-group input, .field-group textarea, .field-group select { flex: 2 0 300px; padding: 6px; border: 1px solid #ccc; border-radius: 5px; }
    .field-group textarea { resize: vertical; }
    button { padding: 10px 20px; margin: 10px 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
    .delete-btn { background-color: #dc3545; color: #fff; }
    .delete-btn:hover { background-color: #a71d2a; }
    .add-btn, .download-btn { background-color: #007BFF; color: #fff; }
    .add-btn:hover, .download-btn:hover { background-color: #0056b3; }
    .row-actions { text-align: center; margin-top: 15px; }
</style>
</head>
<body>

<h1>Publishing Details Form</h1>

<div class="form-container" id="formContainer">
    <div class="card">
        <h3>API Entry 1</h3>
        <div class="field-group">
            <label>API name on Gateway</label>
            <input type="text" class="apiMachineName" placeholder="=camelCase only">
        </div>
        <div class="field-group">
            <label>Display name of API in portal:</label>
            <input type="text" class="apiDisplayName">
        </div>
        <div class="field-group">
            <label>Short description:</label>
            <textarea class="apiDescription"></textarea>
        </div>
        <div class="field-group">
            <label>API Product description:</label>
            <textarea class="apiProductDescription"></textarea>
        </div>
        <div class="field-group">
            <label>API Product features:</label>
            <textarea class="apiProductFeatures"></textarea>
        </div>
        <div class="field-group">
            <label>Category falls under:</label>
            <select class="category">
                <option value="">Select Category</option>
                <option>Building Blocks</option>
                <option>Outbound</option>
                <option>Payment and collection</option>
                <option>Cards</option>
                <option>Accounts and Deposits</option>
                <option>Loans</option>
            </select>
        </div>
            <div class="field-group">
            <label>Workflow:</label>
            <input type="file" class="workFlow" id="WorkflowImage" accept="image/*" onchange="previewWorkflowImage()">
            <img id="workflowPreview" style="margin-top:10px; max-width: 200px; display:none; border: 1px solid #ccc; padding: 5px;">
        </div>
        <div class="field-group">
            <label>Use Cases:</label>
            <textarea class="useCases"></textarea>
        </div>
        <div class="field-group">
            <label>API Product Name:</label>
            <input type="text" class="apiProductName">
        </div>
        <div class="field-group">
            <label>Change Ticket ID:</label>
            <input type="text" class="changeId">
        </div>
     
        <div class="field-group">
            <label>Data Classifications:</label>
            <select class="dataClassifications">
                <option value="">Select Classification</option>
                <option>Transaction Specific</option>
                <option>Sensitive Information</option>
                <option>Personal Identifiable</option>
            </select>
        </div>
           <div class="field-group">
            <label>Data Classification Details:</label>
            <textarea class="dataClassificationDtls"></textarea>
        </div>
            <div class="field-group">
            <label>Description:</label>
            <input type="text" class="desc">
        </div>
   
        <div class="field-group">
            <label>Exception Taken:</label>
            <select class="exceptionTaken">
               <option value=""disabled selected>Select</option>
               <option>Yes</option>
               <option>No</option>
            </select>
        </div>

             <div class="field-group">
            <label>Exception Reason:</label>
            <textarea class="exceptionReason"></textarea>
        </div>
        <div class="field-group">
            <label>GAS ID:</label>
            <input type="text" class="gasInput" placeholder="Start with APIGW">
        </div>
        <div class="field-group">
            <label>JIRA ID:</label>
            <input type="text" class="jiraInput" placeholder="Starts with APIGATE">
        </div>

        <div class="field-group">
            <label for="apiOffering">API Offering:</label>
            <select id="apiOffering" class="apiOffering">
                <option value=""disabled selected>Select API Offering</option>
                <option>System API</option>
                <option>Process API</option>
                <option>Experience API</option>
            </select>
        </div>

        <div class="field-group">
            <label for ="middleware">Middleware:</label>
          <select id="middleware" class="middleware">
        <option value=""disabled selected>Select Middleware</option>
        <option>OBP</option>
        <option>SOA</option>
        <option>OBRH</option>
        <option>NA</option>
          </select>
        </div>

        <div class="field-group">
            <label for="orchestratedPassthrough">Orchestrated or Pass Through</label>
            <select id="orchestratedPassthrough">
                <option value=""disabled selected>Orchestrated or Pass Through</option>
                <option>Orchestrated</option>
                <option>Pass Through</option>                
            </select>

        </div>

        <div class="field-group">
            <label for="apiReusability">API Reusability</label>
            <select id="apiReusability">
                <option value=""disabled selected>API Reusability</option>
                <option>Yes</option>
                <option>No</option>
            </select>
        </div>
        
        <div class="field-group">

            <label for="producer">Producer</label>
            <input type="text">
        </div>

        <div class="field-group">
            <label for="producerUrl">Producer End Point</label>
            <input type="text">
        </div>

        <div class="field-group">
            <label for="appsecTesting">Security Test Status</label>
            <select id="appsecTesting">
                <option value=""disabled selected></option>
                <option>Yes</option>
                <option>No</option>
            </select>
        </div>

        <div class="field-group">
            <label>Hosting Date-Prod:</label>
            <input type="date">
        </div>

        <div class="field-group">
            <label>Hosting Date-UAT:</label>
            <input type="date">
        </div>

        <div class="field-group">
            <label for="riskClassification">API Risk Classification</label>
            <select class="riskClassification">
                <option value=""disbaled selected></option>
                <option>Low</option>
                <option>Medium</option>
                <option>High</option>
            </select>
        </div>

        <div class="field-group">
            <label for="riskScore">Risk Score</label>
            <input type="number" class="riskScore" oninput="updateRiskClassification(this)">
        </div>

     
        <div class="row-actions">
            <button class="delete-btn" onclick="deleteCard(this)">Delete This Entry</button>
        </div>
    </div>
</div>

<div class="row-actions">
    <button class="add-btn" onclick="addCard()">Add New API Entry</button>
    <button class="download-btn" onclick="downloadExcel()">Download Excel</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let entryCount = 1;

function addCard() {
    entryCount++;
    const formContainer = document.getElementById("formContainer");
    const card = document.createElement("div");
    card.classList.add("card");
    card.innerHTML = document.querySelector(".card").innerHTML.replace(/API Entry 1/g, `API Entry ${entryCount}`);
    formContainer.appendChild(card);
}

function deleteCard(btn) {

    const formContainer=document.getElementById("formContainer");
    const cards=formContainer.querySelectorAll(".card");

    if(cards.length==1)
{
    alert("At least one API Entry must remain !!");
    return;
}


    const card = btn.closest(".card");
    card.remove();
}

function isMachineName(str) {
    return /^[a-z]+(-[a-zA-Z]+)*(-v[0-9]+)?$/.test(str);
}

function validateCard(card) {
    const apiMachineName = card.querySelector(".apiMachineName").value.trim();
    if(!isMachineName(apiMachineName)) {
        alert("API MachineName should be in camelCase");
        return false;
    }
    const jiraInput = card.querySelector(".jiraInput").value.trim();
    if(jiraInput && !jiraInput.startsWith("APIGATE")) {
        alert("JIRA must start with APIGATE");
        return false;
    }
    const selects = card.querySelectorAll("select");
    for(let sel of selects){
        if(sel.value === "") {
            alert("Please select a value for " + sel.previousElementSibling.innerText);
            return false;
        }
    }
    return true;
}

function previewWorkflowImage() {
    const fileInput = document.getElementById("workflowImage");
    const preview = document.getElementById("workflowPreview");

    const file = fileInput.files[0];
    if (!file) {
        preview.style.display = "none";
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = "block";
    };
    reader.readAsDataURL(file);
}

function updateRiskClassification(scoreInput) {
    const card = scoreInput.closest('.card'); // find the card this input belongs to
    const classificationSelect = card.querySelector('.riskClassification');
    const score = parseFloat(scoreInput.value);

    if (isNaN(score)) {
        classificationSelect.value = "";
        return;
    }

    if (score >= 0 && score <= 40) {
        classificationSelect.value = "Low";
    } else if (score > 40 && score <= 65) {
        classificationSelect.value = "Medium";
    } else if (score > 65) {
        classificationSelect.value = "High";
    } else {
        classificationSelect.value = "";
    }
}


function downloadExcel() {
    const cards = document.querySelectorAll(".card");
    const wb = XLSX.utils.book_new();
    const wsData = [];

  //Header Row

  // Header row
wsData.push([
    "API Name on Gateway",      // .apiMachineName
    "Display Name",             // .apiDisplayName
    "Short Description",        // .apiDescription
    "API Product Description",  // .apiProductDescription
    "API Product Features",     // .apiProductFeatures
    "Category",                 // .category
    "Workflow File",            // .workflow
    "Use Cases",                // .useCases
    "API Product Name",         // .apiProductName
    "Change Ticket ID",         // .changeId
    "Data Classification",      // .dataClassifications
    "Data Classification Details", // .dataClassificationDtls
    "Description",              // .desc
    "Exception Taken",          // .exceptionTaken
    "Exception Reason",         // .exceptionReason
    "GAS ID",                   // .gasInput
    "JIRA ID",                  // .jiraInput
    "API Offering",             // .apiOffering
    "Middleware",               // .middleware
    "Orchestrated / Pass Through", // .orchestratedPassthrough
    "API Reusability",          // .apiReusability
    "Producer",                 // .producer
    "Producer End Point",       // .producerUrl
    "Security Test Status",     // .appsecTesting
    "Hosting Date UAT",         // .hostingDateUAT
    "Hosting Date PROD",        // .hostingDateProd
    "API Risk Classification",  // .riskClassification
    "Risk Score"                // .riskScore
]);


    for(const card of cards) {
        if(!validateCard(card)) return; // Stop if validation fails
        const inputs = card.querySelectorAll("input, textarea, select");
        const row = [];
        inputs.forEach(input => row.push(input.value));
        wsData.push(row);
    }

    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, "PublishingDetails");
    XLSX.writeFile(wb, "PublishingDetails.xlsx");
}
</script>

</body>
</html>
